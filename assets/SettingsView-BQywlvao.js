import{e as u,d as E,r as m,b as F,c as f,f as t,g as T,h as g,v as y,F as A,i as D,t as U,o as w,_ as j}from"./index-C_jQdxDZ.js";const L="anki_settings";async function B(){const c=await u.settings.get(L);return c==null?void 0:c.ankiConnectUrl}async function K(c,k={}){const r=await B();if(!r)throw new Error("Anki Connect URL not configured.");try{const i=await fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:c,version:6,params:k}),mode:"cors"});if(!i.ok)throw new Error(`HTTP error! status: ${i.status}`);const d=await i.json();if(d.error)throw new Error(`AnkiConnect error: ${d.error}`);return d}catch(i){throw console.error("Error calling AnkiConnect:",i),i}}async function J(){try{const k=(await K("getNumCardsReviewedByDay")).result;for(const[r,i]of k){const d=await u.ankiDailyReviews.where("date").equals(r).first();if(d)d.reviewedCards!==i&&(await u.ankiDailyReviews.update(d.id,{reviewedCards:i}),console.log(`Updated Anki daily review for ${r}: ${i} cards.`));else{const v={date:r,reviewedCards:i,createdAt:new Date};await u.ankiDailyReviews.add(v),console.log(`Added Anki daily review for ${r}: ${i} cards.`)}}}catch(c){throw console.error("Failed to sync Anki daily reviews:",c),c}}const P={class:"settings-view"},q={class:"settings-section"},G={class:"form-group"},H={class:"form-group"},z={class:"settings-section"},Q={class:"form-group"},W={class:"form-group auto-sync-group"},X=["onClick"],Y=["onClick"],Z={key:0,class:"modal-overlay"},ee={class:"modal-content"},te={class:"form-group"},ne={class:"form-group field-input-group"},oe=["value","onInput"],se=["onUpdate:modelValue"],ae=["onClick"],ie=E({__name:"SettingsView",setup(c){const k=m(""),r=m(""),i=m("http://127.0.0.1:8765"),d=m(5),v=m([]),b=m(!1),l=m(null),_=()=>{l.value={name:"",fields:[{id:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),key:"field1",value:""}]},b.value=!0},I=o=>{l.value=JSON.parse(JSON.stringify(o)),b.value=!0},M=()=>{if(l.value){const o=v.value.findIndex(e=>e===l.value);o===-1?v.value.push(l.value):v.value[o]=l.value}S()},R=async()=>{console.log("手动同步 Anki");try{await J(),alert("Anki 同步完成！")}catch(o){console.error("Anki 同步失败:",o),alert("Anki 同步失败，请检查 Anki Connect 是否运行以及 URL 配置是否正确。")}},S=()=>{b.value=!1,l.value=null};F(async()=>{var s;const o=await u.settings.get("ai_settings");o&&(k.value=o.siliconflowApiKey||"",r.value=o.selectedAiModel||"");const e=await u.settings.get("anki_settings");e&&(i.value=e.ankiConnectUrl||"http://127.0.0.1:8765",d.value=e.autoSyncInterval||5,v.value=((s=e.ankiDecks)==null?void 0:s.map(a=>{const n=Object.entries(a.fields).map(([p,C])=>({id:Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15),key:p,value:C}));return{name:a.name,fields:n}}))||[])});const x=o=>{v.value.splice(o,1)},$=o=>{const e=Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);let s=`field${o.fields.length+1}`;for(;o.fields.some(a=>a.key===s);)s=`field${o.fields.length+1+Math.floor(Math.random()*100)}`;o.fields.push({id:e,key:s,value:""})},V=(o,e)=>{const s=o.fields.findIndex(a=>a.id===e);s!==-1&&o.fields.splice(s,1)},N=(o,e,s)=>{const a=o.fields.find(n=>n.id===e);a&&(o.fields.some(n=>n.key===s&&n.id!==e)?alert(`字段名 '${s}' 已存在，请使用其他名称。`):a.key=s)},h=async()=>{const o=v.value.map(e=>{const s={};return e.fields.forEach(a=>{s[a.key]=a.value}),{name:e.name,fields:s}});await u.settings.put({id:"ai_settings",siliconflowApiKey:k.value,selectedAiModel:r.value}),await u.settings.put({id:"anki_settings",ankiConnectUrl:i.value,autoSyncInterval:d.value,ankiDecks:o}),alert("设置已保存！")},O=async()=>{try{const o={words:await u.words.toArray(),grammars:await u.grammars.toArray(),passages:await u.passages.toArray(),settings:await u.settings.toArray()},e=JSON.stringify(o,null,2),s=new Blob([e],{type:"application/json"}),a=URL.createObjectURL(s),n=document.createElement("a");n.href=a,n.download=`soukai_japan_data_${new Date().toISOString().slice(0,10)}.json`,document.body.appendChild(n),n.click(),document.body.removeChild(n),URL.revokeObjectURL(a)}catch(o){console.error("导出数据失败:",o),alert("导出数据失败，请查看控制台了解详情。")}};return(o,e)=>{var s,a;return w(),f(A,null,[t("div",P,[e[14]||(e[14]=t("h1",null,"应用设置",-1)),t("section",q,[e[8]||(e[8]=t("h2",null,"AI 模块设置",-1)),t("div",G,[e[6]||(e[6]=t("label",{for:"siliconflow-api-key"},"SiliconFlow API Key:",-1)),g(t("input",{type:"password",id:"siliconflow-api-key","onUpdate:modelValue":e[0]||(e[0]=n=>k.value=n)},null,512),[[y,k.value]])]),t("div",H,[e[7]||(e[7]=t("label",{for:"ai-model-input"},"AI 模型:",-1)),g(t("input",{type:"text",id:"ai-model-input","onUpdate:modelValue":e[1]||(e[1]=n=>r.value=n),placeholder:"请输入AI模型名称"},null,512),[[y,r.value]])]),t("button",{onClick:h},"保存设置")]),t("section",z,[e[11]||(e[11]=t("h2",null,"Anki 同步设置",-1)),t("div",Q,[e[9]||(e[9]=t("label",{for:"anki-connect-url"},"Anki Connect 地址:",-1)),g(t("input",{type:"text",id:"anki-connect-url","onUpdate:modelValue":e[2]||(e[2]=n=>i.value=n),placeholder:"http://127.0.0.1:8765"},null,512),[[y,i.value]])]),t("div",W,[e[10]||(e[10]=t("label",{for:"auto-sync-interval"},"自动同步间隔 (分钟):",-1)),g(t("input",{type:"number",id:"auto-sync-interval","onUpdate:modelValue":e[3]||(e[3]=n=>d.value=n),min:"1"},null,512),[[y,d.value,void 0,{number:!0}]]),t("button",{onClick:R,class:"manual-sync-button"},"手动同步")]),e[12]||(e[12]=t("h3",null,"Deck 配置",-1)),(w(!0),f(A,null,D(v.value,(n,p)=>(w(),f("div",{key:p,class:"deck-list-item"},[t("span",null,U(n.name||"未命名 Deck"),1),t("div",null,[t("button",{onClick:C=>I(n),class:"edit-deck-button"},"编辑",8,X),t("button",{onClick:C=>x(p),class:"remove-button"},"移除",8,Y)])]))),128)),t("button",{onClick:_,class:"add-deck-button"},"添加 Deck"),t("button",{onClick:h},"保存设置")]),t("section",{class:"settings-section"},[e[13]||(e[13]=t("h2",null,"数据管理",-1)),t("button",{onClick:O},"导出所有数据")])]),b.value?(w(),f("div",Z,[t("div",ee,[t("h3",null,U((s=l.value)!=null&&s.name?"编辑 Deck: "+l.value.name:"添加新 Deck"),1),t("div",te,[e[15]||(e[15]=t("label",{for:"modal-deck-name"},"Deck 名称:",-1)),g(t("input",{type:"text",id:"modal-deck-name","onUpdate:modelValue":e[4]||(e[4]=n=>l.value.name=n)},null,512),[[y,l.value.name]])]),e[17]||(e[17]=t("h4",null,"Field 关键字配置",-1)),(w(!0),f(A,null,D((a=l.value)==null?void 0:a.fields,n=>(w(),f("div",{key:n.id,class:"field-config-item"},[t("div",ne,[t("input",{type:"text",value:n.key,placeholder:"字段名",class:"field-key-input",onInput:p=>N(l.value,n.id,p.target.value)},null,40,oe),e[16]||(e[16]=t("span",{class:"field-separator"},":",-1)),g(t("input",{type:"text","onUpdate:modelValue":p=>n.value=p,placeholder:"显示名称",class:"field-value-input"},null,8,se),[[y,n.value]]),t("button",{onClick:p=>V(l.value,n.id),class:"remove-field-button"}," - ",8,ae)])]))),128)),t("button",{onClick:e[5]||(e[5]=n=>$(l.value)),class:"add-field-button"},"添加 Field"),t("div",{class:"modal-actions"},[t("button",{onClick:M},"保存"),t("button",{onClick:S},"取消")])])])):T("",!0)],64)}}}),re=j(ie,[["__scopeId","data-v-64b5343d"]]);export{re as default};
