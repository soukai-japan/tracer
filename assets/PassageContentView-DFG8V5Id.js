import{d as q,r as v,w as G,j as H,c as a,g as f,f as o,t as r,F as b,i as I,u as Q,e as C,k as U,n as X,l as N,p as Y,o as n,_ as Z}from"./index-CWnjLkSX.js";const ee={class:"passage-content-view"},te={key:0},se={key:1,class:"author"},ae={key:2,class:"passage-analysis"},ne={class:"original-content"},oe={class:"passage-content-wrapper"},re=["disabled"],le=["onClick"],ie=["onClick"],ue={key:0,class:"furigana"},ce=["disabled"],ve={class:"page-indicator"},de={key:3,class:"word-detail-popup"},pe={key:0},fe={key:1},ge={key:2},T=4,he=q({__name:"PassageContentView",setup(me){const M=Y(),z=Q(),p=v(null),c=v(null),l=v(0),$=v(0),m=v([]),A=async e=>{try{const t=await C.passages.get(e);t?(p.value={...t,content:"",translation:""},$.value=await C.passageContents.where({passageId:e}).count(),await P(e,l.value)):(p.value=null,console.warn(`Passage with ID ${e} not found in database.`))}catch(t){console.error("加载文章详情失败:",t),p.value=null}},P=async(e,t)=>{try{y.value.clear(),_.value.clear();const s=t*T,i=await C.passageContents.where({passageId:e}).offset(s).limit(T).sortBy("segmentIndex");m.value=i.map(u=>u.content)}catch(s){console.error(`加载第 ${t} 页内容失败:`,s),m.value=[]}},g=v(null);G(()=>M.params.id,async e=>{e&&(g.value=Number(e),l.value=0,await A(g.value))},{immediate:!0});const y=v(new Map),_=v(new Map),B=v(!1),O=async e=>{const t=m.value[e];if(t){_.value.set(e,!0);try{const s=await J(t);y.value.set(e,s)}catch(s){console.error("分析段落失败:",s)}finally{_.value.set(e,!1)}}},J=async e=>{const t=e;if(!t)return[];try{const s=await C.settings.get("ai_settings"),i=s==null?void 0:s.siliconflowApiKey,u=s==null?void 0:s.selectedAiModel;if(!i||!u)return alert("请先在设置中配置SiliconFlow API Key和模型"),B.value=!1,[];const W=t.match(/[^。！？]+[。！？]?/g)||[];let w=[];for(const R of W){const K=`请对以下日语句子进行详细的词法分析，并以JSON数组格式返回结果。每个对象应包含以下字段："word", "pos", "furigana", "romaji"。

请特别注意以下分析要求：
1. 将助动词与对应动词正确结合。如"食べた"应作为一个单词，而不是分开为"食べ"和"た"。
2. 正确识别动词的时态变化，如"いた"是"いる"的过去时，应作为一个完整单词处理。
3. 合理处理助词，应当与前后词汇适当分离。
4. 避免过度分词，特别是对于构成一个语法或语义单位的组合。
5. 对于复合词，如"持って行く"，根据语义和使用习惯确定是作为一个词还是分开处理。

确保输出是严格的JSON格式，不包含任何markdown或其他非JSON字符。

待解析句子： "${R}"`,j=await fetch("https://api.siliconflow.cn/v1/chat/completions",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${i}`},body:JSON.stringify({model:u,messages:[{role:"user",content:K}],temperature:.7})});if(!j.ok)throw new Error(`API请求失败: ${j.statusText}`);let k=(await j.json()).choices[0].message.content;try{const h=k.match(/```json\n([\s\S]*?)\n```/);h&&h[1]&&(k=h[1]);const E=JSON.parse(k);w=w.concat(E)}catch(h){console.error("解析分词结果失败:",h,k)}}return w}catch(s){return console.error("分析文章失败:",s),alert("分析文章失败，请稍后重试"),[]}},L=e=>{c.value=e},S=H(()=>Math.ceil($.value/T)),d=v(null),V=async()=>{l.value>0&&(d.value&&(d.value.classList.add("animate-left"),setTimeout(()=>{d.value&&d.value.classList.remove("animate-left")},500)),l.value--,g.value&&await P(g.value,l.value))},x=async()=>{l.value<S.value-1&&(d.value&&(d.value.classList.add("animate-right"),setTimeout(()=>{d.value&&d.value.classList.remove("animate-right")},500)),l.value++,g.value&&await P(g.value,l.value))},D=()=>{z.back()},F=e=>e.startsWith("名詞")?"pos-noun":e.startsWith("動詞")?"pos-verb":e.startsWith("形容詞")?"pos-adjective":e.startsWith("助詞")?"pos-particle":e.startsWith("助動詞")?"pos-aux-verb":e.startsWith("副詞")?"pos-adverb":e.startsWith("接続詞")?"pos-conjunction":e.startsWith("感動詞")?"pos-interjection":e.startsWith("連体詞")?"pos-adnominal":e.startsWith("接頭詞")?"pos-prefix":e.startsWith("接尾詞")?"pos-suffix":e.startsWith("記号")?"pos-symbol":e.startsWith("フィラー")?"pos-filler":e.startsWith("その他")?"pos-other":"pos-unknown";return(e,t)=>(n(),a("div",ee,[p.value?(n(),a("h1",te,r(p.value.name),1)):f("",!0),p.value?(n(),a("p",se,"作者: "+r(p.value.author),1)):f("",!0),p.value?(n(),a("div",ae,[o("div",ne,[o("div",oe,[o("button",{onClick:V,disabled:l.value===0,class:"nav-button left-nav"},t[1]||(t[1]=[o("span",{class:"triangle left"},null,-1)]),8,re),o("div",{class:"passage-segments",ref_key:"passageSegmentsRef",ref:d},[(n(!0),a(b,null,I(m.value,(s,i)=>(n(),a("p",{key:"current-segment-"+i,class:"passage-segment-item",onClick:u=>O(i)},[y.value.has(i)?(n(!0),a(b,{key:0},I(y.value.get(i),(u,W)=>(n(),a("span",{key:"token-"+i+"-"+W,class:X(["word-token",F(u.pos)]),onClick:U(w=>L(u),["stop"])},[N(r(u.word)+" ",1),u.furigana?(n(),a("span",ue,r(u.furigana),1)):f("",!0)],10,ie))),128)):_.value.get(i)?(n(),a(b,{key:1},[N(r(s)+" ",1),t[2]||(t[2]=o("span",{class:"loading-spinner"},null,-1))],64)):(n(),a(b,{key:2},[N(r(s),1)],64))],8,le))),128))],512),o("button",{onClick:x,disabled:l.value>=S.value-1,class:"nav-button right-nav"},t[3]||(t[3]=[o("span",{class:"triangle right"},null,-1)]),8,ce)]),o("div",ve,[o("span",null,r(l.value+1)+" / "+r(S.value),1)])])])):f("",!0),c.value?(n(),a("div",de,[o("h3",null,r(c.value.word),1),c.value.furigana?(n(),a("p",pe,"假名: "+r(c.value.furigana),1)):f("",!0),c.value.romaji?(n(),a("p",fe,"罗马字: "+r(c.value.romaji),1)):f("",!0),c.value.pos?(n(),a("p",ge,"词性: "+r(c.value.pos),1)):f("",!0),o("button",{class:"close-button",onClick:t[0]||(t[0]=s=>c.value=null)},"×")])):f("",!0),o("button",{onClick:D},"返回")]))}}),we=Z(he,[["__scopeId","data-v-55473dfe"]]);export{we as default};
